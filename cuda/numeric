//
// Created by egi on 1/26/20.
//

#ifndef LIBCUPP_PROPOSAL_NUMERIC_H
#define LIBCUPP_PROPOSAL_NUMERIC_H

#include "detail/__reduce"

namespace cuda {

enum thread_scope {
  thread_scope_system,
  thread_scope_device,
  thread_scope_block,
  thread_scope_warp
};

template<typename T, typename... Rest>
struct is_any : std::false_type {};

template<typename T, typename First>
struct is_any<T, First> : std::is_same<T, First> {};

template<typename T, typename First, typename... Rest>
struct is_any<T, First, Rest...> : std::integral_constant<bool, std::is_same<T, First>::value || is_any<T, Rest...>::value>
{};

template <int required_cc>
constexpr bool check_compute_capability ()
{
#if defined(__CUDA_ARCH__)
  return __CUDA_ARCH__ >= required_cc;
#else
  return false;
#endif
}

template<
    typename _Tp,
    typename _ReducePolicy = typename std::conditional<
        std::integral_constant<bool, is_any<_Tp,
                                            int,
                                            long,
                                            long long,
                                            unsigned int,
                                            unsigned long,
                                            unsigned long long,
                                            float,
                                            double>::value
                                  && check_compute_capability<300>()>::value,
                               detail::__warp_shfl_reduce<_Tp>,
                               detail::__warp_shrd_reduce<_Tp>>::type>
class warp_reduce : public _ReducePolicy {
public:
  using _ReducePolicy::_ReducePolicy;

  template<typename _RandomAccessIterator, typename _BinaryOperation = detail::__default_reduce_binary_op<_Tp>>
  __device__ inline _Tp
  operator ()(_RandomAccessIterator __first, _RandomAccessIterator __last, _Tp __init, _BinaryOperation __binary_op = {})
  {
    for (__first += detail::lane_id(); __first < __last; __first += warpSize)
      __init = __binary_op (__init, *__first);
    return __reduce_value (__init, __binary_op);
  }

  template<typename _BinaryOperation = detail::__default_reduce_binary_op<_Tp>>
  __device__ inline _Tp
  operator ()(_Tp __val, _BinaryOperation __binary_op = {})
  {
    return __reduce_value (__val, __binary_op);
  }
};

}

#endif //LIBCUPP_PROPOSAL_NUMERIC_H
